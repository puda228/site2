<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #2481cc);
        }

        .stat-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999);
        }

        .tasks {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .task {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-radius: 12px;
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .task:not(.completed):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .task.completed {
            opacity: 0.7;
            background: var(--tg-theme-secondary-bg-color, #e8e8e8);
        }

        .task.completed::before {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            color: #4CAF50;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
        }

        .task-points {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
        }

        .task-description {
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .complete-btn {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #fff);
            border: none;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 16px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .complete-btn:hover {
            opacity: 0.9;
        }

        .level-badge {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .level-easy {
            background: #4CAF50;
            color: white;
        }

        .level-medium {
            background: #FFC107;
            color: black;
        }

        .level-hard {
            background: #F44336;
            color: white;
        }

        .task-completed {
            animation: completeTask 0.5s ease-out;
            background: var(--tg-theme-secondary-bg-color, #e8f5e9) !important;
        }

        @keyframes completeTask {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .points-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--tg-theme-button-color, #2481cc);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 18px;
            animation: popupAnimation 1s ease-out forwards;
            z-index: 1000;
        }

        @keyframes popupAnimation {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–ó–∞–¥–∞–Ω–∏—è</h1>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="points">0</div>
                <div class="stat-label">–û—á–∫–∏</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completed-tasks">0</div>
                <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
        </div>
    </div>

    <div class="tasks" id="tasks-container"></div>

    <script>
        // Explicitly attach functions to window object
        window.userPoints = 0;
        window.completedTasks = [];
        window.tasks = [];
        window.webapp = null;

        window.completeTask = function(taskId) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (!taskElement) return;

            // Add completion animation
            taskElement.classList.add('task-completed');

            // Show points popup
            const points = taskElement.getAttribute('data-points');
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.textContent = `+${points} –æ—á–∫–æ–≤!`;
            document.body.appendChild(popup);

            // Remove popup after animation
            setTimeout(() => {
                popup.remove();
            }, 1000);

            // Update progress
            const taskData = window.tasks.find(t => t.id === taskId);
            if (taskData) {
                window.completedTasks.push(taskId);
                window.userPoints += taskData.points;
                window.updateStats();
                window.saveProgress();
            }

            // Remove completion animation class after delay
            setTimeout(() => {
                taskElement.classList.remove('task-completed');
            }, 500);
        };

        window.updateStats = function() {
            document.getElementById('points').textContent = window.userPoints;
            document.getElementById('completed-tasks').textContent = window.completedTasks.length;
        };

        window.saveProgress = function() {
            try {
                if (!window.webapp) {
                    window.webapp = window.Telegram.WebApp;
                }
                
                if (!window.webapp) {
                    throw new Error('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }

                // –°–æ–∑–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                const params = new URLSearchParams();
                params.append('progress', window.userPoints);
                params.append('completed', JSON.stringify(window.completedTasks));
                
                const queryString = params.toString();
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:', {
                    progress: window.userPoints,
                    completed: window.completedTasks,
                    queryString: queryString
                });
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                window.webapp.sendData(queryString);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                window.webapp.showPopup({
                    title: '–£—Å–ø–µ—Ö',
                    message: `–ó–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! +${window.userPoints} –æ—á–∫–æ–≤`
                });
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö:', e);
                try {
                    if (window.webapp && typeof window.webapp.showPopup === 'function') {
                        window.webapp.showPopup({
                            title: '–û—à–∏–±–∫–∞',
                            message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: ' + e.message
                        });
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + e.message);
                    }
                } catch (popupError) {
                    alert('–û—à–∏–±–∫–∞: ' + e.message);
                }
            }
        };

        window.getLevelBadge = function(level) {
            return `<span class="level-badge level-${level}">${
                level === 'easy' ? '–õ–µ–≥–∫–æ' :
                level === 'medium' ? '–°—Ä–µ–¥–Ω–µ' : '–°–ª–æ–∂–Ω–æ'
            }</span>`;
        };

        window.renderTasks = function() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';

            window.tasks.forEach(task => {
                const isCompleted = window.completedTasks.includes(task.id);
                const taskElement = document.createElement('div');
                taskElement.className = `task ${isCompleted ? 'completed' : ''}`;
                taskElement.setAttribute('data-task-id', task.id);
                taskElement.setAttribute('data-points', task.points);
                
                taskElement.innerHTML = `
                    <div class="task-header">
                        <div class="task-title">
                            ${task.title}
                            ${window.getLevelBadge(task.level)}
                        </div>
                        <div class="task-points">üèÖ ${task.points}</div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    ${!isCompleted ? `
                        <button class="complete-btn" onclick="window.completeTask(${task.id})">
                            –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ
                        </button>
                    ` : ''}
                `;

                container.appendChild(taskElement);
            });

            window.updateStats();
        };

        // –î–æ–∂–∏–¥–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ WebApp
        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                initApp();
            } else {
                setTimeout(() => {
                    if (window.Telegram && window.Telegram.WebApp) {
                        window.Telegram.WebApp.ready();
                        initApp();
                    } else {
                        console.error('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏');
                        alert('–û—à–∏–±–∫–∞: Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                    }
                }, 1000);
            }
        });

        function initApp() {
            window.webapp = window.Telegram.WebApp;
            console.log('WebApp initialized:', {
                version: window.webapp.version,
                platform: window.webapp.platform,
                initData: window.webapp.initData
            });
            
            window.webapp.expand();

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            window.userPoints = parseInt(urlParams.get('progress')) || 0;
            let completedTasksData = urlParams.get('completed') || '[]';
            
            try {
                window.completedTasks = JSON.parse(completedTasksData);
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ —Å–ø–∏—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π:', e);
                window.completedTasks = [];
            }

            console.log('URL Parameters:', {
                userId,
                userPoints: window.userPoints,
                completedTasksData
            });

            window.tasks = [
                {
                    id: 1,
                    title: "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ",
                    description: "–ò–∑—É—á–∏—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –µ–≥–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
                    points: 5,
                    level: "easy"
                },
                {
                    id: 2,
                    title: "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
                    description: "–†–µ—à–∏—Ç–µ –∑–∞–¥–∞—á—É: –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 2 + 2 √ó 2?",
                    points: 10,
                    level: "medium"
                },
                {
                    id: 3,
                    title: "–ó–∞–≥–∞–¥–∫–∞",
                    description: "–ß—Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏?",
                    points: 15,
                    level: "medium"
                },
                {
                    id: 4,
                    title: "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",
                    description: "–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–≤–æ–¥–∏—Ç 'Hello, World!'",
                    points: 20,
                    level: "hard"
                }
            ];

            window.renderTasks();

            window.webapp.MainButton.text = "–ó–∞–∫—Ä—ã—Ç—å";
            window.webapp.MainButton.onClick(() => {
                window.webapp.close();
            });
            window.webapp.MainButton.show();
        }
    </script>
</body>
</html>
